server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    root   /usr/share/nginx/html;
    index  index.html index.htm;
    
    # Mike version selector and redirect handling
    # Redirect to latest if no version specified and accessing root
    location = / {
        try_files $uri $uri/ /latest/;
    }
    
    # Handle mike version selector requests
    location /versions.json {
        try_files $uri =404;
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }
    
    # Handle legacy redirects from old URL structure
    if ( $request_uri = '/latest/')
        {
          return 301 https://docs.virtocommerce.org/latest;
        }
        
    location / {
        try_files $uri $uri/ =404;
        
        # Legacy URL redirects for backward compatibility
        rewrite ^/latest/(.*)$ /$1 permanent;

        rewrite ^/new/user_docs/storefront/(.*)$ /storefront/user-guide/$1 permanent; 
        rewrite ^/new/user_docs/marketplace_user_docs/(.*)$ /marketplace/user-guide/$1 permanent; 

        rewrite ^/new/user_docs/(.*)$ /platform/user-guide/$1 permanent; 

        rewrite ^/new/dev_docs/storefront-development/(.*)$ /storefront/developer-guide/$1 permanent;
        rewrite ^/new/dev_docs/(.*)$ /platform/developer-guide/$1 permanent;
        rewrite ^/new/(.*)$ /$1 permanent;

        # Version-specific routing
        # Try to find the file in the requested version directory
        # If not found, fall back to the version's index.html
        location ~ ^/([^/]+)/ {
            try_files $uri $uri/ /$1/index.html =404;
        }
    }

    # Handle mike's version selector
    location /js/ {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=3600";
    }
    
    location /css/ {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=3600";
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}